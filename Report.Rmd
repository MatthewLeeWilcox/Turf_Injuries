---
title: "Impact on Field Surface and Player Injuries"
author: "Matthew Wilcox, Randy Otoo, Logan Lapace"
output:
  html_document:
    code_folding: hide
    highlight: default
    theme: united
    self_contained: false
    warning: false

  knitr:
    warning: false 
    echo: false

---

# Introduction

This year, fans of the NFL have watched their favorite teams compete week in and week out. However, many fans are saddened and angered that they have been unable to watch their favorite players not being on the field due to injuries. Especially after Aaron Rodgers tore his Achilles in the first game of the season, The NFLPA executive director Lloyd Howell called upon all NFL owners to convert their stadium from turf to grass, according to ESPN. With this recent outcry for the switch, we want to see if there is a correlation between the field surface and the injuries while comparing it with various factors.

# Libraries
```{r, echo = TRUE, warning = FALSE, eval = FALSE}

library(data.table)
library(tidyverse)
library(gridExtra)
library(png)
library(grid)
library(patchwork)
```

```{r, echo = FALSE, warning = FALSE}

library(data.table)
library(tidyverse)
library(gridExtra)
library(png)
library(grid)
library(patchwork)
```

# Data Descrition

```{r, warning = FALSE}
injury_data <- fread("InjuryRecord.csv")

PlayerTD <- fread("PlayerTrackData.csv")

PlayList <- fread("PlayList.csv")
```


The NFL 1st and Future - Analytics Kaggle Competition acquired the data. This competition was Hosted in 2019 by the NFL to investigate the relationship between the playing surface and the injury and performance of NFL Athletes. This provided three datasets. The first consisted of the injuries. This provided us with the Injury type, the player/play it occurred on, and how long that player was out after that injury. The second data set was of the player telemetry data. This data provided information such as the player's speed and the player's movement for individual plays. The final dataset gave us data on the plays. It showed the person involved in the play, what type of play it was, the weather at the time of the play, and finally, the field surface. 

Data Source: https://www.kaggle.com/competitions/nfl-playing-surface-analytics/data

# Data Cleaning 

# Lower Body Injury Comparison

# Surface impact on Injury Day

```{r, warning = FALSE}
injury_data$days_out <- injury_data$DM_M1 + injury_data$DM_M7 + injury_data$DM_M28 + injury_data$DM_M42

Injury_len_df <- injury_data %>% select(BodyPart, Surface, days_out)

injury_len_df.natural <- Injury_len_df %>% filter( Surface == "Natural") 
len_natural <- nrow(injury_len_df.natural)
injury_len_df.natural <- injury_len_df.natural %>% group_by(days_out) %>%
  summarise(prop = n()/len_natural)  
injury_len_df.natural$surface <- "Natural"

injury_len_df.Synthetic <- Injury_len_df %>% filter( Surface == "Synthetic") 
len_Synthetic <- nrow(injury_len_df.Synthetic)
injury_len_df.Synthetic <- injury_len_df.Synthetic %>% group_by(days_out) %>%
  summarise(prop = n()/len_Synthetic)  
injury_len_df.Synthetic$surface <- "Synthetic"


Injury_len_df.surface_count <- rbind(injury_len_df.natural, injury_len_df.Synthetic) %>% 
  arrange(desc(days_out))
Injury_len_df.surface_count <- Injury_len_df.surface_count %>%
  mutate(days_out = case_when(
    days_out == 4 ~ "42 + days",
    days_out == 3 ~ "28-42 days",
    days_out == 2 ~ "7-28 days", 
    days_out == 1 ~ "1-7 days out"
  ))
days_out_order <- c("1-7 days out","7-28 days","28-42 days","42 + days")
Injury_len_df.surface_count$days_out <- factor(Injury_len_df.surface_count$days_out, levels = days_out_order)


injury_len_map <- ggplot(Injury_len_df.surface_count, aes(x=surface, y = days_out, fill = prop)) +
  geom_tile() + 
  geom_text(aes(label = paste(round(prop*100,3), "%")))+
  scale_fill_gradientn(colors =  c(  "white", "orange")) + 
  ggtitle("Percentage of the Injury Length by Field Surface ") +
  ylab("Days Out Injured") +
  xlab("Field Surface")
  
injury_len_map
```
The graph above shows the proportion of the injuries that happened on synthetic and natural grass fields for the length of the injury. The two field surfaces follow similar patterns with the length of the injury, especially if the injury caused them to be out more than 42 days or between 1 and 7 days. However, the biggest change is from 7-28 and 28-42 days. The injuries on natural grass had less from 28-42 and more from 7-28. For this data, the proportionally more players who got injured on a Synthetic grass field for approximately a month or more while on grass had proportionally more injuries lasting a couple of weeks. 

# Surface and Weather

# Player Movement and the Field Surface


```{r, warning = FALSE}
get_max_play <- function(input_df, play_col, play_val, max_column){
  df <- input_df %>% filter(!!as.symbol(play_col) == {{play_val}})
  max.val <- max(df[[max_column]])
  max.val
}
```

```{r, warning = FALSE}
Injury_speeds <- lapply(as.list(injury_data$PlayKey), get_max_play, input_df = PlayerTD, play_col="PlayKey", max_column = "s")
injury_data$Speeds <- Injury_speeds

```

```{r, warning = FALSE}
injury_data <- na.omit(injury_data)
injury_data <- injury_data %>%
  select(BodyPart, Surface, Speeds, PlayKey)
injury_data$Speeds <- as.numeric(injury_data$Speeds)
injury_data <- injury_data[injury_data$Speeds >= 0]
```

We have looked at a variety of factors that could impact the injury with relation to the field surface. But we havent discussed what the individual was doing at the time of injury. With the telemetry data provided we can observe this. The primary factor we are looking at is going to be the speed on the player of the injury. For this it is not just the speed but the max speed the player reached on the play. 


```{r, warning = FALSE}


speed_synthetic <-ggplot(injury_data[injury_data$Surface == "Synthetic"], aes(x=Speeds)) +
  geom_histogram(bins = 10) +
  xlab("Speed (Yards Per Second)") +
  ggtitle("Speed at Injury on Synthetic")
speed_Natural <- ggplot(injury_data[injury_data$Surface == "Natural"], aes(x=Speeds))+
  geom_histogram(bins = 10)+
  xlab("Speed (Yards Per Second)") +
  ggtitle("Speed at Injury on Natural")
grid.arrange(speed_synthetic, speed_Natural, nrow = 1)
```

These two graphs show the maximum speed on the play where the injury occurred. What is seen is that on natural grass, the speed at which the injury occurs appears to be a bit more uniform than on synthetic grass. The synthetic graph appears slightly left skew, while natural grass has a more uniform distribution. This could indicate that synthetic grass has more injuries at higher speeds while natural grass is consistent in its injuries at any speed.

```{r, warning = FALSE}
Knee_injury <- injury_data[injury_data$BodyPart == "Knee"]
kspeed_synthetic <-ggplot(Knee_injury[Knee_injury$Surface == "Synthetic"], aes(x=Speeds)) +
  geom_histogram(bins = 10, fill="Black") +
  ggtitle("Speed of Knee-Injury on Synthetic") + 
  xlab("Speed (Yards Per Second)") +
  xlim(1,10)+
  ylim(0,5)
kspeed_Natural <- ggplot(Knee_injury[Knee_injury$Surface == "Natural"], aes(x=Speeds))+
  geom_histogram(bins = 10, fill = "Black")+
  ggtitle("Speed of Knee-Injury on Natural") + 
  xlab("Speed (Yards Per Second)") +
  xlim(1,10)+
  ylim(0,5)

Ankle_injury <- injury_data[injury_data$BodyPart == "Ankle"]
Ank.speed_synthetic <-ggplot(Ankle_injury[Ankle_injury$Surface == "Synthetic"], aes(x=Speeds)) +
  geom_histogram(bins = 10, fill = "Orange") +
  ggtitle("Speed of Ankle-Injury on Synthetic") + 
  xlab("Speed (Yards Per Second)") +
  xlim(1,10)+
  ylim(0,5)
Ank.speed_Natural <- ggplot(Ankle_injury[Ankle_injury$Surface == "Natural"], aes(x=Speeds))+
  geom_histogram(bins = 10, fill = "Orange")+
  ggtitle("Speed of Ankle-Injury on Natural") + 
  xlab("Speed (Yards Per Second)") +
  xlim(1,10)+
  ylim(0,5)

Foot_injury <- injury_data[injury_data$BodyPart == "Foot"]
fo.speed_synthetic <-ggplot(Foot_injury[Foot_injury$Surface == "Synthetic"], aes(x=Speeds)) +
  geom_histogram(bins = 10,fill = "Sky Blue") +
  ggtitle("Speed of Foot-Injury on Synthetic") + 
  xlab("Speed (Yards Per Second)") +
  xlim(0,10)+
  ylim(0,5)
fo.speed_Natural <- ggplot(Foot_injury[Foot_injury$Surface == "Natural"], aes(x=Speeds))+
  geom_histogram(bins = 10, fill = "Sky Blue")+
  ggtitle("Speed of Foot-Injury on Natural") + 
  xlab("Speed (Yards Per Second)") +
  xlim(1,10)+
  ylim(0,5)


grid.arrange(kspeed_synthetic,Ank.speed_synthetic, fo.speed_synthetic,
             kspeed_Natural, Ank.speed_Natural, fo.speed_Natural,  ncol = 3)

```
If we split out the injuries by the body part that the injury occurred on we can get more insights. There are not enough foot injuries to really determine a difference. For Knee injuries, the distributions are relatively similar. However for Ankle injuries, there were more injuries that occured at higher speeds on Synthetic Grass. 




# Percentage of Games Played previously on Turf and Injury



```{r, warning = FALSE}
Injury_plays <- filter( PlayerTD,
  PlayKey %in% unique(injury_data$PlayKey)
)
```

```{r, warning = FALSE}

graph_play <- function(df, play, col, graph_name){
  df <- filter(df, !!as.symbol(col) == {{play}})
  img <- readPNG("football.png")
  g <- rasterGrob(img, interpolate = TRUE)
  temp_name  <- paste("Graph", gsub("-", "_", play), sep = ".")
  temp_graph <- ggplot(df, aes(x,y, color = s))+
  xlim(0,120) + 
  ylim(0,53.3) + 
  annotation_custom(g, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf) +
  geom_point() + coord_flip()+
    scale_color_gradient(
      low = "blue",
      high = "orange",
      limits=c(0,10)
    )
    geom_segment(aes(
      xend = c(tail(x, n=-1), NA),
      yend = c(tail(y, n=-1), NA)
    ))
  assign(graph_name, temp_graph, envir = .GlobalEnv)
}

# get_max_play <- function(input_df, play_col, play_val, max_column){
#   df <- input_df %>% filter(!!as.symbol(play_col) == {{play_val}})
#   max.val <- max(df[[max_column]])
#   max.val

# graph_play(PlayerTD, "39873-4-32", "PlayKey")

k.injury_play_list <- unique(Knee_injury$PlayKey)
counter <- 0
for(play in k.injury_play_list){
  graph_name <- paste("g", counter, sep = "")
  graph_play(PlayerTD, play, "PlayKey", graph_name)
  counter <- counter +1
}
```

Below is visualizations of the plays that lead to the injuries. The color of the dots represent the speed of the player at that moment where they are on the field in the play. The injuries are only knee injuries that occurred. One common trait that is observed is that in majority of the plays that had knee injuries, the player was cutting and stopping after going fast. 


```{r, warning = FALSE}
(g0 | g1)
  (g2 | g3)
(g4 | g5)
  (g7 | g6)
(g8 | g9)
  (g11 | g10)
(g12 | g14)
  (g13 | g15)
(g19 | g16)
  (g18 | g17)
(g20 | g28)
  (g21 | g29)
(g22 | g30)
  (g23 | g31)
(g24 | g32)
  (g25 | g33)
(g26 | g34)
  (g27 | g35)
```
